# 1 指令集筛选

我组选择的指令集组合：RV32IM

该指令集组合包含以下类型的指令：

- RV32I(基本整数指令子集) 47条
  1. 整数运算指令
  2. 分支跳转指令
  3. 整数 Load/Store 指令（存储器读写）
  4. CSR 指令（Control and Status Register，处理器核内部的控制和状态寄存器）
  5. 存储器屏障 （FENCE）指令
  6. 特殊指令 ECALL 、 EBREAK、 MRET、 WFI
- RV32M（整数乘法和除法指令）8条
  1. 整数乘法指令
  2. 整数除法指令

以下是对我组指令集筛选的解释。

## 1.1 模块化的指令集

​		RISC-V 的指令集使用模块化的方式进行组织，每一个模块使用一个英文字母来表示。它使得设计者能够灵活地选择不同的模块进行组合，以满足不同的应用场景。

​		针对小面积、低功耗的嵌入式场景，用户可以选择 RV32IC 组合的指令集，仅使用机器模式；针对高性能应用操作系统场景，则可以选择例如 RV32IMFDC 的指令集，使用机器模式与用户模式两种模式。

## 1.2 选择的理由

​		RISC-V 最基本也是唯一强制要求实现的指令集部分是基本整数指令子集。 使用该整数指令子集，便能够实现完整的软件编译器。其他的指令子集部分均为可选的模块。	

​		RISC-V的基本指令集分为不同位数的几种，我组选择RV32I（32位），并且不支持扩展指令集C（压缩指令，指令长度为16位，指令与RV32I一一对应），因而我组筛选的指令集中的指令是等长的32位，这就简化了硬件设计。

​		我组另外支持扩展指令集M（整数乘法与除法指令）。支持该指令集对硬件的要求是提供乘法器与除法器，而未引入过高的复杂度。

# 2 CPU功能设定

 	1. 仅支持机器模式
 	2. 支持中断、异常
 	3. 支持外设接口

## 2.1 中断、异常

广义的异常包含了中断、异常两个概念。

RISC-V定义的中断类型分为4种：

- 外部中断 （External Interrupt ）
- 计时器中断（Timer Interrupt ）
- 软件中断（ Software Interrupt ）
- 调试中断（Debug Interrupt ）

我组的目标是支持前三者，并实现一个PLIC来管理多个外部中断源，不支持调试中断。

关于异常，我组计划是支持RISC-V架构规定的有关机器模式的异常。

### 2.1.1 外部中断、计时器中断、软件中断

- 外部中断

  ​		外部中断指来自处理器核外部的中断，如外部设备产生的中断。

  ​		RISC-V只明确定义了一个机器模式外部中断，但是提供了支持多个外部中断源的方式：

     1. 明确定义可通过 PLIC（Level Interrupt Controller，平台级别中断控制器）管理众多的外部中断源将其仲裁成为一根机器模式外部中断信号；

     2. 通过CSV寄存器用于自定义中断的异常编号与控制

        我组目标为实现一个PLIC来管理多个外部中断源。

- 计时器中断

  ​		RISC-V 架构定义了系统平台中必须有一个计时器，并给该计时器定义了两个 64 位宽的寄存器 mtime 和 mtimecmp 。mtime 寄存器用于反映当前 计时器的计数值， mtimecmp 用于设置计时器的比较值。当mtime的值大于等于mtimecmp的值时产生计时器中断。

  ​		RISC-V 架构定义 mtime 定时器为实时（Real-Time）计时器，系统必须以一种恒定的频率作为计时器的时钟。 计时器默认打开，因而mtime会一直计数以反应准确的计时（但可通过CSR寄存器 mcounters控制）。软件需通过修改mtimecmp的值（使其大于mtime的值）来清除计时器中断。

- 软件中断

  ​		RISC-V 架构定义的机器模式软件中断可以通过软件写 1 至 msip 寄存器来触发。msip被定义为存储器地址映射的系统寄存器，具体映射地址RISC-V没有规定。

### 2.1.2 中断屏蔽

​		RISC-V规定狭义的异常不可被屏蔽，狭义的中断可以被屏蔽。RISC-V定义了CSR 寄存器：机器模式中断使能寄存器 mie (Machine Interrupt Enable Registers）， 用于控制中断的屏蔽，其中每个比特位用于控制每个单独的中断使能。

### 2.1.3 中断嵌套

​		RISC-V定义进入异常处理时，mstatus 寄存器中的MIE域将被硬件自动更新成为 0 （意味着中断被全局关闭，从而无法响应新的中断），即RlSC-V 架构定义的硬件机制默认无法支持硬件中断嵌套。但是，RISC-V允许用户通过软件方式实现、或通过自定义中断控制器在硬件上实现中断嵌套功能。

​		我组的目前计划是不支持中断嵌套。

### 2.1.4 中断优先级与仲裁

​	如果同时发生多种中断（我组的设计共有3种中断），RISC-V架构规定响应的优先级从高到低如下：

   			1. 外部中断
      			2. 软件中断
         			3. 计时器中断

对于多个外部中断源，由PLIC管理其优先级和仲裁。

## 2.2 接口

我组计划支持I/O接口。

为了支持处理器核的对外接口，需实现处理器核的BIU模块（Bus Interface Unit，总线接口单元），并定义总线协议。

为了支持I/O接口主动与CPU通信，需支持外部中断功能。我组计划实现PLIC，因此需实现相应的中断入口程序。

### 2.2.1 BIU

​		BIU负责接收存储器访问请求，通过识别其访问的地址区间访问不同接口。

### 2.2.2 总线协议

​		暂定为使用蜂鸟E200 定义的ICB总线协议。

### 2.2.3 支持的接口类型

1. I/O接口
2. 存储器接口
3. PLIC接口
4. CLINT接口

# 3 数据通路

我组拟实现两级流水线单发射。

- IFU（取指单元）
  1. IFU在绝大多数情况下应从ITCM处取指，极少数情况下需访问BIU，这需通过地址判断和 ICB 总线控制；
  2. 我组选择的指令集模块是等长的32位指令集，因而不需考虑不等长指令的情况；
  3. 由于我组计划支持流水线，因而在取指阶段不仅需取当前指令，并且还需得到下条指令的PC值。若当前指令是条件分支跳转指令，则需预测下条指令的PC值；
  4. 对第3点进一步解释：IFU单元需对取回的指令进行简单译码，若译码得知其为条件分支跳转指令，则需进行分支预测。我组拟采用静态分支预测；
  5. 分支预测可能得出错误的PC值，当在流水线的下级发现分支预测错误时，应有流水线冲刷机制。

- EXU（执行单元）
  1. EXU从IR得到当前指令并进行译码；
  2. 根据译码结果派遣指令：所有的指令都会派遣给ALU，但是对于长指令类型的 Load/Store 指令，会通过  ALU 的 AGU 子单元进一步发送至LSU（这类访存指令通过复用ALU的加法器得到访存的地址，通过LSU 去执行访存操作）。由于所有的指令都会派遣给ALU，因此实际的派遣发生在ALU的内部器件之间，具体解释为：派遣模块产生指示信号，ALU根据指示信号将指令派遣给不同的单元执行；
  3. 根据译码出的操作数寄存器索引读整数通用寄存器 Integer-Regfile （由于RISC-V指令最多有2个操作数，且我组设计为单发射，因而 Integer-Regfile 只需2个读端口）；
  4. 交付;
  5. 写回；
  6. 出于简化的目的（避免流水线冲突），在IFU与EXU之间增设EXU-ready信号线，表示当前EXU是否空闲，只有当处于执行阶段的指令执行完EXU空闲时，才允许下一条指令进入执行阶段。

